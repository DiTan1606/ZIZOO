<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Weather Safety API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            margin-right: 10px;
        }
        .safe { background: #10b981; }
        .caution { background: #f59e0b; }
        .warning { background: #ef4444; }
        .danger { background: #991b1b; }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            color: #6b7280;
            font-style: italic;
        }
        .error {
            color: #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå§Ô∏è Test Weather Safety API</h1>

        <!-- Test 1: OpenWeatherMap -->
        <div class="test-section">
            <h3>1. Test OpenWeatherMap API</h3>
            <p>L·∫•y th·ªùi ti·∫øt hi·ªán t·∫°i v√† d·ª± b√°o cho ƒê√† L·∫°t</p>
            <button onclick="testOpenWeather()">Test OpenWeatherMap</button>
            <div id="opm-result"></div>
        </div>

        <!-- Test 2: TomTom Traffic -->
        <div class="test-section">
            <h3>2. Test TomTom Traffic API</h3>
            <p>L·∫•y t√¨nh h√¨nh giao th√¥ng t·∫°i ƒê√† L·∫°t</p>
            <button onclick="testTomTom()">Test TomTom</button>
            <div id="tomtom-result"></div>
        </div>

        <!-- Test 3: Critical Routes -->
        <div class="test-section">
            <h3>3. Test Critical Routes (ƒê√† L·∫°t)</h3>
            <p>Ki·ªÉm tra c√°c tuy·∫øn ƒë∆∞·ªùng quan tr·ªçng (ƒê√®o Prenn, ƒê√®o Mimosa)</p>
            <button onclick="testCriticalRoutes()">Test Critical Routes</button>
            <div id="routes-result"></div>
        </div>

        <!-- Test 4: Combined Analysis -->
        <div class="test-section">
            <h3>4. Test Combined Analysis</h3>
            <p>Ph√¢n t√≠ch t·ªïng h·ª£p an to√†n chuy·∫øn ƒëi</p>
            <button onclick="testCombined()">Test Combined</button>
            <div id="combined-result"></div>
        </div>
    </div>

    <script>
        const OPM_API_KEY = 'a0c3bdef674df3ff86bc7ef7a834c503';
        const TOMTOM_API_KEY = 'lazvNskZKUnxr0XLLiEdbGW8BMbERuKan';

        // T·ªça ƒë·ªô ƒê√† L·∫°t
        const DA_LAT = { lat: 11.9404, lng: 108.4583 };

        async function testOpenWeather() {
            const resultDiv = document.getElementById('opm-result');
            resultDiv.innerHTML = '<p class="loading">ƒêang t·∫£i...</p>';

            try {
                // Current weather
                const currentRes = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${DA_LAT.lat}&lon=${DA_LAT.lng}&appid=${OPM_API_KEY}&units=metric&lang=vi`
                );
                const current = await currentRes.json();

                // Forecast
                const forecastRes = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${DA_LAT.lat}&lon=${DA_LAT.lng}&appid=${OPM_API_KEY}&units=metric&lang=vi`
                );
                const forecast = await forecastRes.json();

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Th√†nh c√¥ng!</h4>
                        <p><strong>Hi·ªán t·∫°i:</strong> ${current.weather[0].description}, ${Math.round(current.main.temp)}¬∞C</p>
                        <p><strong>Gi√≥:</strong> ${current.wind.speed} km/h</p>
                        <p><strong>ƒê·ªô ·∫©m:</strong> ${current.main.humidity}%</p>
                        <p><strong>D·ª± b√°o:</strong> ${forecast.list.length} ƒëi·ªÉm d·ªØ li·ªáu (5 ng√†y)</p>
                        <details>
                            <summary>Xem JSON</summary>
                            <pre>${JSON.stringify({ current, forecast: forecast.list.slice(0, 3) }, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result"><p class="error">‚ùå L·ªói: ${error.message}</p></div>`;
            }
        }

        async function testTomTom() {
            const resultDiv = document.getElementById('tomtom-result');
            resultDiv.innerHTML = '<p class="loading">ƒêang t·∫£i...</p>';

            try {
                const bbox = `${DA_LAT.lng - 0.5},${DA_LAT.lat - 0.5},${DA_LAT.lng + 0.5},${DA_LAT.lat + 0.5}`;
                
                const res = await fetch(
                    `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox}&key=${TOMTOM_API_KEY}&categoryFilter=0,1,2,3,4,5,6,7,8,9,10,11,14`
                );
                const data = await res.json();

                const incidents = data.incidents || [];
                const roadsClosed = incidents.filter(i => 
                    i.properties.iconCategory === 2 || i.properties.iconCategory === 3
                );

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Th√†nh c√¥ng!</h4>
                        <p><strong>T·ªïng incidents:</strong> ${incidents.length}</p>
                        <p><strong>ƒê∆∞·ªùng ƒë√≥ng:</strong> ${roadsClosed.length}</p>
                        ${roadsClosed.length > 0 ? `
                            <p><strong>Chi ti·∫øt:</strong></p>
                            <ul>
                                ${roadsClosed.slice(0, 3).map(i => 
                                    `<li>${i.properties.description || 'ƒê∆∞·ªùng b·ªã ƒë√≥ng'}</li>`
                                ).join('')}
                            </ul>
                        ` : '<p>Kh√¥ng c√≥ ƒë∆∞·ªùng b·ªã ƒë√≥ng</p>'}
                        <details>
                            <summary>Xem JSON</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result"><p class="error">‚ùå L·ªói: ${error.message}</p></div>`;
            }
        }

        async function testCriticalRoutes() {
            const resultDiv = document.getElementById('routes-result');
            resultDiv.innerHTML = '<p class="loading">ƒêang ki·ªÉm tra...</p>';

            const routes = [
                { name: 'ƒê√®o Prenn', lat: 11.8833, lng: 108.4333 },
                { name: 'ƒê√®o Mimosa', lat: 11.5500, lng: 107.8000 },
                { name: 'ƒê√† L·∫°t Center', lat: 11.9404, lng: 108.4583 }
            ];

            try {
                const results = await Promise.all(
                    routes.map(async (route) => {
                        const bbox = `${route.lng - 0.1},${route.lat - 0.1},${route.lng + 0.1},${route.lat + 0.1}`;
                        
                        const res = await fetch(
                            `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox}&key=${TOMTOM_API_KEY}`
                        );
                        const data = await res.json();

                        const incidents = data.incidents || [];
                        const critical = incidents.filter(i => 
                            i.properties.iconCategory === 2 || i.properties.iconCategory === 3
                        );

                        return {
                            name: route.name,
                            isOpen: critical.length === 0,
                            incidents: critical.length,
                            details: critical.map(i => i.properties.description || 'V·∫•n ƒë·ªÅ giao th√¥ng')
                        };
                    })
                );

                const allOpen = results.every(r => r.isOpen);
                const allClosed = results.every(r => !r.isOpen);

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Ki·ªÉm tra ho√†n t·∫•t!</h4>
                        ${allClosed ? `
                            <p class="error">üö´ T·∫§T C·∫¢ ƒê∆Ø·ªúNG CH√çNH ƒê·ªÄU ƒê√ìNG - KH√îNG TH·ªÇ V√ÄO ƒê√Ä L·∫†T!</p>
                        ` : allOpen ? `
                            <p style="color: #10b981; font-weight: 600;">‚úÖ T·∫•t c·∫£ ƒë∆∞·ªùng ƒë·ªÅu th√¥ng tho√°ng</p>
                        ` : `
                            <p style="color: #f59e0b; font-weight: 600;">‚ö†Ô∏è M·ªôt s·ªë ƒë∆∞·ªùng b·ªã ƒë√≥ng</p>
                        `}
                        
                        <div style="margin-top: 16px;">
                            ${results.map(route => `
                                <div style="padding: 12px; margin: 8px 0; border-radius: 8px; background: ${route.isOpen ? '#f0fdf4' : '#fef2f2'}; border: 2px solid ${route.isOpen ? '#86efac' : '#fca5a5'};">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="font-size: 18px;">${route.isOpen ? '‚úÖ' : 'üö´'}</span>
                                        <strong>${route.name}</strong>
                                        ${route.isOpen ? 
                                            '<span style="color: #10b981; font-size: 12px;">(Th√¥ng tho√°ng)</span>' : 
                                            '<span style="color: #dc2626; font-size: 12px;">(B·ªã ƒë√≥ng)</span>'
                                        }
                                    </div>
                                    ${!route.isOpen && route.details.length > 0 ? `
                                        <div style="font-size: 12px; color: #dc2626; margin-top: 8px;">
                                            ${route.details.map(d => `‚Ä¢ ${d}`).join('<br>')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result"><p class="error">‚ùå L·ªói: ${error.message}</p></div>`;
            }
        }

        async function testCombined() {
            const resultDiv = document.getElementById('combined-result');
            resultDiv.innerHTML = '<p class="loading">ƒêang ph√¢n t√≠ch...</p>';

            try {
                // Get weather
                const currentRes = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${DA_LAT.lat}&lon=${DA_LAT.lng}&appid=${OPM_API_KEY}&units=metric&lang=vi`
                );
                const current = await currentRes.json();

                const forecastRes = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${DA_LAT.lat}&lon=${DA_LAT.lng}&appid=${OPM_API_KEY}&units=metric&lang=vi`
                );
                const forecast = await forecastRes.json();

                // Get traffic
                const bbox = `${DA_LAT.lng - 0.5},${DA_LAT.lat - 0.5},${DA_LAT.lng + 0.5},${DA_LAT.lat + 0.5}`;
                const trafficRes = await fetch(
                    `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox}&key=${TOMTOM_API_KEY}`
                );
                const traffic = await trafficRes.json();

                // Analyze
                let score = 100;
                const issues = [];

                const rain = current.rain?.['1h'] || 0;
                const wind = current.wind.speed;
                const roadsClosed = (traffic.incidents || []).filter(i => 
                    i.properties.iconCategory === 2 || i.properties.iconCategory === 3
                ).length;

                if (rain > 100) { score -= 25; issues.push('M∆∞a r·∫•t l·ªõn'); }
                else if (rain > 50) { score -= 10; issues.push('M∆∞a l·ªõn'); }
                
                if (wind > 60) { score -= 25; issues.push('Gi√≥ r·∫•t m·∫°nh'); }
                else if (wind > 40) { score -= 10; issues.push('Gi√≥ m·∫°nh'); }

                if (roadsClosed > 10) { score -= 40; issues.push(`${roadsClosed} ƒë∆∞·ªùng ƒë√≥ng`); }
                else if (roadsClosed > 5) { score -= 25; issues.push(`${roadsClosed} ƒë∆∞·ªùng ƒë√≥ng`); }
                else if (roadsClosed > 0) { score -= 10; issues.push(`${roadsClosed} ƒë∆∞·ªùng ƒë√≥ng`); }

                let status, statusClass, icon;
                if (score >= 80) { status = 'An to√†n'; statusClass = 'safe'; icon = '‚úÖ'; }
                else if (score >= 50) { status = 'C√¢n nh·∫Øc'; statusClass = 'caution'; icon = '‚ö†Ô∏è'; }
                else if (score >= 20) { status = 'Kh√¥ng n√™n ƒëi'; statusClass = 'warning'; icon = 'üî¥'; }
                else { status = 'Nguy hi·ªÉm'; statusClass = 'danger'; icon = 'üö®'; }

                resultDiv.innerHTML = `
                    <div class="result">
                        <h4>‚úÖ Ph√¢n t√≠ch ho√†n t·∫•t!</h4>
                        <p>
                            <span class="status-badge ${statusClass}">${icon} ${status}</span>
                            <strong>ƒêi·ªÉm: ${score}/100</strong>
                        </p>
                        <p><strong>Th·ªùi ti·∫øt:</strong> ${current.weather[0].description}, ${Math.round(current.main.temp)}¬∞C</p>
                        <p><strong>M∆∞a:</strong> ${rain}mm/h</p>
                        <p><strong>Gi√≥:</strong> ${wind} km/h</p>
                        <p><strong>ƒê∆∞·ªùng ƒë√≥ng:</strong> ${roadsClosed}</p>
                        ${issues.length > 0 ? `
                            <p><strong>V·∫•n ƒë·ªÅ:</strong> ${issues.join(', ')}</p>
                        ` : '<p><strong>Kh√¥ng c√≥ v·∫•n ƒë·ªÅ</strong></p>'}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result"><p class="error">‚ùå L·ªói: ${error.message}</p></div>`;
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ƒê√† L·∫°t Routes - TomTom API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        .status-open {
            color: #10b981;
            font-weight: bold;
        }
        .status-closed {
            color: #ef4444;
            font-weight: bold;
        }
        .incident {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .summary {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèîÔ∏è Test ƒê√† L·∫°t Routes</h1>
        <p class="subtitle">Ki·ªÉm tra t√¨nh tr·∫°ng ƒê√®o Prenn & Mimosa qua TomTom API</p>
        
        <button onclick="checkRoutes()" id="checkBtn">
            üîç Ki·ªÉm tra t√¨nh tr·∫°ng ƒë∆∞·ªùng
        </button>
        
        <div id="result"></div>
    </div>

    <script>
        const TOMTOM_API_KEY = 'lazvNskZKUnxr0XLLiEdbGW8BMbERuKa'; // API key t·ª´ Python code
        const BBOX_PASSES = '108.42,11.85,108.50,11.95'; // Bbox bao tr√πm khu v·ª±c ƒë√®o

        async function checkRoutes() {
            const btn = document.getElementById('checkBtn');
            const resultDiv = document.getElementById('result');
            
            btn.disabled = true;
            resultDiv.innerHTML = '<div class="loading">‚è≥ ƒêang qu√©t radar khu v·ª±c ƒë√®o...</div>';
            
            try {
                const url = `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${BBOX_PASSES}&key=${TOMTOM_API_KEY}&fields={incidents{type,geometry{type,coordinates},properties{iconCategory,events{description}}}}&language=vi-VN&t=${Date.now()}`;
                
                console.log('üîç Calling TomTom API:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const incidents = data.incidents || [];
                
                console.log('üìä API Response:', data);
                
                // Ph√¢n t√≠ch k·∫øt qu·∫£
                let output = `üì° QU√âT RADAR KHU V·ª∞C ƒê√àO PRENN & MIMOSA\n`;
                output += `   V√πng qu√©t: ${BBOX_PASSES}\n`;
                output += `   Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}\n`;
                output += `${'='.repeat(60)}\n\n`;
                
                output += `üìä T·ªïng s·ªë s·ª± c·ªë ph√°t hi·ªán: ${incidents.length}\n\n`;
                
                // L·ªçc s·ª± c·ªë nghi√™m tr·ªçng
                const prennIncidents = [];
                const mimosaIncidents = [];
                const otherIncidents = [];
                
                incidents.forEach(incident => {
                    const cat = incident.properties.iconCategory;
                    const coords = incident.geometry.coordinates;
                    const point = Array.isArray(coords[0]) ? coords[0] : coords;
                    const desc = incident.properties.events?.[0]?.description || 'No description';
                    
                    const incidentData = {
                        category: cat,
                        categoryName: getCategoryName(cat),
                        description: desc,
                        lat: point[1],
                        lng: point[0]
                    };
                    
                    // Ch·ªâ quan t√¢m s·ª± c·ªë nghi√™m tr·ªçng: 6=T·∫Øc, 8=ƒê√≥ng, 9=Thi c√¥ng
                    if (cat === 6 || cat === 8 || cat === 9) {
                        if (point[1] > 11.90) {
                            prennIncidents.push(incidentData);
                        } else if (point[1] >= 11.85 && point[1] <= 11.90) {
                            mimosaIncidents.push(incidentData);
                        } else {
                            otherIncidents.push(incidentData);
                        }
                    }
                });
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ ƒê√®o Prenn
                output += `üèîÔ∏è ƒê√àO PRENN (QL20)\n`;
                output += `   V·ªã tr√≠: Lat > 11.90\n`;
                if (prennIncidents.length === 0) {
                    output += `   ‚úÖ TR·∫†NG TH√ÅI: TH√îNG THO√ÅNG\n`;
                } else {
                    output += `   üö´ TR·∫†NG TH√ÅI: C√ì S·ª∞ C·ªê (${prennIncidents.length} v·∫•n ƒë·ªÅ)\n`;
                    prennIncidents.forEach((inc, i) => {
                        output += `\n   S·ª± c·ªë ${i + 1}:\n`;
                        output += `   - Lo·∫°i: ${inc.categoryName}\n`;
                        output += `   - M√¥ t·∫£: ${inc.description}\n`;
                        output += `   - T·ªça ƒë·ªô: ${inc.lat.toFixed(6)}, ${inc.lng.toFixed(6)}\n`;
                    });
                }
                output += `\n`;
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ ƒê√®o Mimosa
                output += `üèîÔ∏è ƒê√àO MIMOSA (B·∫¢O L·ªòC)\n`;
                output += `   V·ªã tr√≠: 11.85 < Lat < 11.90\n`;
                if (mimosaIncidents.length === 0) {
                    output += `   ‚úÖ TR·∫†NG TH√ÅI: TH√îNG THO√ÅNG\n`;
                } else {
                    output += `   üö´ TR·∫†NG TH√ÅI: C√ì S·ª∞ C·ªê (${mimosaIncidents.length} v·∫•n ƒë·ªÅ)\n`;
                    mimosaIncidents.forEach((inc, i) => {
                        output += `\n   S·ª± c·ªë ${i + 1}:\n`;
                        output += `   - Lo·∫°i: ${inc.categoryName}\n`;
                        output += `   - M√¥ t·∫£: ${inc.description}\n`;
                        output += `   - T·ªça ƒë·ªô: ${inc.lat.toFixed(6)}, ${inc.lng.toFixed(6)}\n`;
                    });
                }
                output += `\n`;
                
                // T·ªïng k·∫øt
                output += `${'='.repeat(60)}\n`;
                output += `üìã T·ªîNG K·∫æT:\n`;
                output += `   - ƒê√®o Prenn: ${prennIncidents.length === 0 ? '‚úÖ An to√†n' : 'üö´ C√≥ v·∫•n ƒë·ªÅ'}\n`;
                output += `   - ƒê√®o Mimosa: ${mimosaIncidents.length === 0 ? '‚úÖ An to√†n' : 'üö´ C√≥ v·∫•n ƒë·ªÅ'}\n`;
                
                if (prennIncidents.length > 0 || mimosaIncidents.length > 0) {
                    output += `\n‚ö†Ô∏è C·∫¢NH B√ÅO: C√≥ s·ª± c·ªë tr√™n ƒë∆∞·ªùng v√†o ƒê√† L·∫°t!\n`;
                    output += `   N√™n ki·ªÉm tra k·ªπ tr∆∞·ªõc khi kh·ªüi h√†nh.\n`;
                } else {
                    output += `\n‚úÖ TIN VUI: C·∫£ 2 ƒë√®o ƒë·ªÅu th√¥ng tho√°ng!\n`;
                    output += `   C√≥ th·ªÉ y√™n t√¢m kh·ªüi h√†nh.\n`;
                }
                
                resultDiv.innerHTML = `<pre>${output}</pre>`;
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.innerHTML = `<div style="color: red; padding: 20px;">
                    ‚ùå L·ªñI: ${error.message}
                    <br><br>
                    Chi ti·∫øt: ${error.stack || 'Kh√¥ng c√≥ th√¥ng tin'}
                </div>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        function getCategoryName(category) {
            const names = {
                0: 'Unknown',
                1: 'Accident',
                2: 'Fog',
                3: 'Dangerous Conditions',
                4: 'Rain',
                5: 'Ice',
                6: 'Jam (T·∫Øc ƒë∆∞·ªùng nghi√™m tr·ªçng)',
                7: 'Lane Closed',
                8: 'Road Closed (ƒê√≥ng ƒë∆∞·ªùng)',
                9: 'Road Works (Thi c√¥ng)',
                10: 'Wind',
                11: 'Flooding',
                14: 'Broken Down Vehicle'
            };
            return names[category] || `Category ${category}`;
        }
        
        // Auto-run khi load trang
        window.addEventListener('load', () => {
            console.log('üöÄ Page loaded, ready to check routes');
        });
    </script>
</body>
</html>
